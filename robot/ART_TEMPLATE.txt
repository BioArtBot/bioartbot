from opentrons import labware, instruments

metadata = {
    'protocolName': 'CCL ARTBot',
    'author': 'Tim Dobbs and Counter Culture Labs',
    'source': 'ARTBot Protocol Builder'
    }

class AgarBrush('Pipette'): #maybe don't subclass it at all. Might just be complicating things

    def distribute_to_agar(self, vol, source, destination, disposal_vol):
        if not self.current_tip():
            raise ValueError("%s does not have a pipette tip attached" % self)

        dest = list(destination) #allows for non-lists

        for cnt, well in enumerate(dest):
            if self.VOLUME_IN_PIPETTE < vol: #TODO
                remaining_wells = len(dest) - cnt
                remaining_vol = remaining_wells * vol

                if remaining_vol > self.max_volume:
                    asp_vol = math.floor(self.max_volume / vol) * vol
                else:
                    asp_vol =  remaining_vol

                self.aspirate(asp_vol, source)

            self.dispense(vol, well.top(),0.25)

            dip_position = robot._driver.position
            dip_position['Z'] = dip_position['Z'] - 7
            robot._driver.move(dip_position)

        self.TRASH_TIP #TODO

# a 6-well plate for all of the colors in our pallette
palette = labware.load('falcon_6_wellplate_15.5ml_flat', 1)

# a tip rack for our pipette
p200rack = labware.load('tiprack-200ul', 10)

# red solution location
red = palette.wells('A1')
# blue solution location
blue = palette.wells('A2')
# green solution location
green = palette.wells('A3')


# plate to create art in
plate = labware.load('CCL_ARTBot_canvas', 5)

# wells to dispense each color material to
red_wells = [
    well.top() for well in plate.wells(%%RED WELLS GO HERE%%)]
blue_wells = [
    well.top() for well in plate.wells(%%BLUE WELLS GO HERE%%)]
green_wells = [
    well.top() for well in plate.wells(%%GREEN WELLS GO HERE%%)]

def run_custom_protocol(
        pipette_axis: 'StringSelection...'='left'):

    p300 = AgarBrush(
        instruments.P300_Single(
            mount=pipette_axis,
            tip_racks=[p200rack]
        )
    )

    p300.distribute_to_agar(5, red, red_wells, disposal_vol=0)
    p300.distribute_to_agar(5, blue, blue_wells, disposal_vol=0)
    p300.distribute_to_agar(5, green, green_wells, disposal_vol=0)


if __name__ == '__main__': run_custom_protocol(**{'pipette_axis': 'left'})
